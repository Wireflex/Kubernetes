# ArgoCD
декларативный инструмент непрерывной доставки GitOps для кубера. Реализован как контроллер кубернетес, который постоянно отслеживает запущенные приложения и сравнивает текущее реальное состояние с желаемым целевым как указано в репозитории git; приложение, текущее состояние которого отличается от целевого, считается out-of-sync и ArgoCD позволяет вручную или автоматически синхронизировать реальное состояние с желаеымм. Может управлять несколькими кубер-кластерами
## GitOps - это методология, которая позволяет перенести лучшие практики програмного обеспечения в инфраструктурные проекты, при её использовании git-репозиторий становится единственным источником правда о желаемом состоянии системы.
![image](https://github.com/user-attachments/assets/5767e7cd-4fb8-4738-b338-676f3400f934)
[Установка](https://argo-cd.readthedocs.io/en/stable/getting_started/)
<details> <summary>ArgoCD</summary>

```
kubectl create namespace argocd
kubectl apply -n argocd -f https://raw.githubusercontent.com/argoproj/argo-cd/stable/manifests/install.yaml
```
</details>
Для продакшна лучше устанавливать
<details> <summary>ArgoCD_HA</summary>

```
kubectl create namespace argocd
kubectl apply -n argocd -f https://raw.githubusercontent.com/argoproj/argo-cd/v2.12.3/manifests/ha/install.yaml
```
</details>
Устанавливаем ArgoCD-cli

```
ARGOCD_VERSION=$(curl --silent "https://api.github.com/repos/argoproj/argo-cd/releases/latest" | grep '"tag_name"' | sed -E 's/.*"([^"]+)".*/\1/')
curl -sSL -o /tmp/argocd-${ARGOCD_VERSION} https://github.com/argoproj/argo-cd/releases/download/${ARGOCD_VERSION}/argocd-linux-amd64
chmod +x /tmp/argocd-v2.12.3 # свою версию
sudo mv /tmp/argocd-v2.12.3  /usr/local/bin/argocd 
argocd version --client
```
Генерируем первичный пароль ```argocd admin initial-password -n argocd```

В локальном миникуб кластере юзаем cubectl port-forward ```kubectl port-forward svc/argocd-server -n argocd 8080:443```

После установки ArgoCD установились 

![image](https://github.com/user-attachments/assets/337619ee-8241-4f03-bb3f-53d35d63faff)

### ArgoCD App Project 
это custom resourse definition ( crd ) - объект кубера, который предоставляет логическую группу ArgoCD-апликейшнов 

<details> <summary>dev.yaml</summary>

```
apiVersion: argoproj.io/v1alpha1
kind: AppProject
metadata:
  name: development
  namespace: argocd
  finalizers:      # Нужен для того,чтобы убедиться, что проект не будет удалён пока к нему приатачены ArgoCD приложения
    - resources-finalizer.argocd.argoproj.io
spec:
  description: Project containing development environment services
  sourceRepos:   # ссылка на репозитории, из которых приложения в рамках проекта, могут извлекать манифесты, чарт-файлы итд
    - '*'        # любой репозиторий
  destinations:       # ссылки на namespaces и кластера, в которые ArgoCD приложения могут деплоить кубер-ресурсы
    - namespace: '*'  # так же, любой namespace( если указать, к примеру 'dota', то апликейшены смогли бы деплоить только туда )
      server: '*'
  clusterResourceWhitelist:   # какие объекты кластерного уровня могут устанавливать ArgoCD апликейшены в рамках проекта
    - group: '*' 
      kind: '*'
```
</details>
и еще 1
<details> <summary>infra.yaml</summary>

```
apiVersion: argoproj.io/v1alpha1
kind: AppProject
metadata:
  name: infrastructure
  namespace: argocd
  # Finalizer that ensures that project is not deleted until it is not referenced by any application
  finalizers:
    - resources-finalizer.argocd.argoproj.io
spec:
  description: Project with infrastructure related applications
  sourceRepos:
    - '*'
  destinations:
    - namespace: '*'
      server: '*'
  clusterResourceWhitelist:
    - group: '*'
      kind: '*'
```
</details>
в WebUI тож появились 

![image](https://github.com/user-attachments/assets/34d833ec-95a0-4781-9a1f-90012a155ce0)

По умолчанию ArgoCD имеет доступ к кластеру, внутрь которого он был установлен, но можно подключить сторонние кластеры

![image](https://github.com/user-attachments/assets/5a609ce3-708d-4a00-998c-e5380a2e273c)

### ArgoCD Application
отвечает за установку кубер-объектов (деплоймент,сервис,ингрес итд) и за их управление

<details> <summary>kuber.yaml</summary>

```
apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: kuber
  # You'll usually want to add your resources to the argocd namespace.
  namespace: argocd
  # Add this finalizer ONLY if you want these to cascade delete.
  finalizers:
    - resources-finalizer.argocd.argoproj.io
spec:
  project: development     # это то,что создали выше в dev.yaml

  source:   # из какого репозитория брать исходный код 
    repoURL: https://github.com/Wireflex/Kubernetes.git  # Can point to either a Helm chart repo or a git repo.
    targetRevision: main  # For Helm, this refers to the chart version.
    path: ArgoCD/dev/kuber  # This has no meaning for Helm charts pulled directly from a Helm repo instead of git.

  destination:    # куда деплоим (у нас только 1 дефолтный)
    server: https://kubernetes.default.svc
    namespace: kuber

  # Sync policy
  syncPolicy:
    automated: # automated sync by default retries failed attempts 5 times with following delays between attempts ( 5s, 10s, 20s, 40s, 80s ); retry controlled using `retry` field.
      prune: true # Specifies if resources should be pruned during auto-syncing ( false by default ).
      selfHeal: true # Specifies if partial app sync should be executed when resources are changed only in target Kubernetes cluster and no git change detected ( false by default ).
    syncOptions:     # Sync options which modifies sync behavior
    - CreateNamespace=true # Namespace Auto-Creation ensures that namespace specified as the application destination exists in the destination cluster.
```
</details>
